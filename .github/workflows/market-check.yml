name: Market Strength - daily job

on:
  workflow_dispatch:   # cho phép chạy thủ công
  schedule:
    - cron: '30 1 * * *'   # chạy mỗi ngày 08:30 sáng VN (01:30 UTC)

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install requests pandas vnstock python-dotenv

    - name: Prepare folders
      run: |
        mkdir -p data_hist
        mkdir -p logs

    - name: Run download scripts
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        if [ -f download_history_vnstock.py ]; then python download_history_vnstock.py; fi
        if [ -f download_history_cophieu68.py ]; then python download_history_cophieu68.py; fi
        if [ -f download_daily.py ]; then python download_daily.py; fi

    - name: Normalize
      run: |
        if [ -f normalize_data_hist.py ]; then python normalize_data_hist.py; fi

    - name: Compute score
      run: |
        python compute.py > compute_output.json

    - name: Send Telegram
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        python notify_market.py

    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: compute-output
        path: compute_output.json
